'use client';

import { cn } from '@/lib/utils';
import { DiamondGrid } from './DiamondGrid';
import {
  HOUSE_POSITIONS,
  RASHI_POSITIONS,
  CHART_SIZES,
  type HouseData,
  type ChartSize,
} from './constants';

interface DiamondChartProps {
  houses: HouseData[];
  title?: string;
  subtitle?: string;
  size?: ChartSize;
  showRashiNumbers?: boolean;
  showAscLabel?: boolean;
  showHouseNumbers?: boolean;
  onPlanetClick?: (planetKey: string) => void;
  onHouseClick?: (houseNumber: number) => void;
  className?: string;
}

/**
 * Check if house is a triangular corner (less space)
 * Houses 2,3,5,6,8,9,11,12 = triangular corners (limited space)
 * Houses 1,4,7,10 = diamond centers (plenty of space)
 */
function isTriangularHouse(houseNumber: number): boolean {
  return [2, 3, 5, 6, 8, 9, 11, 12].includes(houseNumber);
}

/**
 * Calculate grid position for a planet
 */
function getPlanetGridPosition(
  index: number,
  totalPlanets: number
): { offsetX: number; offsetY: number } {
  // 1-2 planets: vertical line (centered)
  if (totalPlanets <= 2) {
    return {
      offsetX: 0,
      offsetY: index * 45 - ((totalPlanets - 1) * 45) / 2,
    };
  }

  // 3-4 planets: 2x2 grid
  if (totalPlanets <= 4) {
    const row = Math.floor(index / 2);
    const col = index % 2;
    const gridWidth = 40;
    const gridHeight = 35;
    
    return {
      offsetX: col * gridWidth - gridWidth / 2,
      offsetY: row * gridHeight - ((Math.ceil(totalPlanets / 2) - 1) * gridHeight) / 2,
    };
  }

  // 5-6 planets: 3x2 grid
  const row = Math.floor(index / 3);
  const col = index % 3;
  const gridWidth = 32;
  const gridHeight = 32;
  
  return {
    offsetX: col * gridWidth - gridWidth,
    offsetY: row * gridHeight - ((Math.ceil(totalPlanets / 3) - 1) * gridHeight) / 2,
  };
}

/**
 * Get dynamic rashi number position to avoid overlap
 */
function getRashiNumberPosition(
  houseNumber: number,
  planetCount: number
): { x: number; y: number } {
  const basePos = RASHI_POSITIONS[houseNumber];
  
  if (planetCount >= 3) {
    const adjustments: Record<number, { dx: number; dy: number }> = {
      1: { dx: 0, dy: -15 },
      2: { dx: -20, dy: -10 },
      3: { dx: -25, dy: 0 },
      4: { dx: -25, dy: 0 },
      5: { dx: -25, dy: 0 },
      6: { dx: -20, dy: 10 },
      7: { dx: 0, dy: 15 },
      8: { dx: 20, dy: 10 },
      9: { dx: 25, dy: 0 },
      10: { dx: 25, dy: 0 },
      11: { dx: 25, dy: 0 },
      12: { dx: 20, dy: -10 },
    };
    
    const adjustment = adjustments[houseNumber] || { dx: 0, dy: 0 };
    return {
      x: basePos.x + adjustment.dx,
      y: basePos.y + adjustment.dy,
    };
  }
  
  return basePos;
}

/**
 * DiamondChart - North Indian chart with smart font sizing
 * 
 * Font sizing logic:
 * - Houses 1,4,7,10 (diamond centers): ALWAYS large fonts (plenty of space)
 * - Houses 2,3,5,6,8,9,11,12 (triangular corners):
 *   - 1-3 planets: Large fonts (still okay)
 *   - 4+ planets: Reduce fonts (getting crowded)
 */
export function DiamondChart({
  houses,
  title,
  subtitle,
  size = 'lg',
  showRashiNumbers = true,
  showAscLabel = true,
  showHouseNumbers = false,
  onPlanetClick,
  onHouseClick,
  className,
}: DiamondChartProps) {
  const sizeConfig = CHART_SIZES[size];
  const ascendantHouse = houses.find((h) => h.isAscendant);

  /**
   * Smart font sizing based on house type and planet count
   * 
   * Diamond houses (1,4,7,10): Always large (plenty of space)
   * Triangular houses (2,3,5,6,8,9,11,12): Only reduce with 4+ planets
   */
  const getFontSizes = (houseNumber: number, planetCount: number) => {
    // Diamond houses (1,4,7,10): Always use large fonts
    if (!isTriangularHouse(houseNumber)) {
      return {
        degree: 9,
        symbol: 16,
        status: 9,
      };
    }
    
    // Triangular houses: Reduce only when crowded (4+ planets)
    if (planetCount >= 4) {
      return {
        degree: planetCount >= 5 ? 7 : 8,
        symbol: planetCount >= 5 ? 11 : 13,
        status: planetCount >= 5 ? 7 : 8,
      };
    }
    
    // Triangular houses with 1-3 planets: Still large
    return {
      degree: 9,
      symbol: 16,
      status: 9,
    };
  };

  return (
    <div className={cn('w-full mx-auto', className)} style={{ maxWidth: sizeConfig.maxWidth }}>
      {title && (
        <div className="text-center mb-2">
          <h3 className="text-lg font-semibold text-[hsl(var(--chart-text))]">
            {title}
          </h3>
          {subtitle && (
            <p className="text-sm text-[hsl(var(--chart-text-secondary))]">
              {subtitle}
            </p>
          )}
        </div>
      )}

      <div className="aspect-square">
        <DiamondGrid>
          {/* Rashi Numbers */}
          {showRashiNumbers && houses.map((house) => {
            const pos = getRashiNumberPosition(house.houseNumber, house.planets.length);
            return (
              <text
                key={`rashi-${house.houseNumber}`}
                x={pos.x}
                y={pos.y}
                fontSize="16"
                fontWeight="500"
                textAnchor="middle"
                dominantBaseline="middle"
                className="fill-[hsl(var(--chart-text-secondary))]"
              >
                {house.rasiNumber}
              </text>
            );
          })}

          {/* House Numbers (debug) */}
          {showHouseNumbers && houses.map((house) => {
            const pos = HOUSE_POSITIONS[house.houseNumber];
            return (
              <text
                key={`house-num-${house.houseNumber}`}
                x={pos.x}
                y={pos.y - 70}
                fontSize="11"
                fontWeight="400"
                textAnchor="middle"
                dominantBaseline="middle"
                className="fill-[hsl(var(--chart-text-secondary))] opacity-50"
              >
                H{house.houseNumber}
              </text>
            );
          })}

          {/* ASC Label */}
          {showAscLabel && ascendantHouse && (
            <text
              x={300}
              y={220}
              fontSize="14"
              fontWeight="bold"
              textAnchor="middle"
              dominantBaseline="middle"
              className="fill-[hsl(var(--chart-asc))]"
            >
              ASC
            </text>
          )}

          {/* Planets */}
          {houses.map((house) => {
            if (house.planets.length === 0) return null;

            const basePos = HOUSE_POSITIONS[house.houseNumber];
            const fontSizes = getFontSizes(house.houseNumber, house.planets.length);

            return (
              <g key={`planets-house-${house.houseNumber}`}>
                {house.planets.map((planet, index) => {
                  const gridPos = getPlanetGridPosition(index, house.planets.length);
                  const x = basePos.x + gridPos.offsetX;
                  const y = basePos.y + gridPos.offsetY;
                  const isClickable = !!onPlanetClick;

                  return (
                    <g
                      key={`planet-${planet.key}`}
                      onClick={() => onPlanetClick?.(planet.key)}
                      style={{ cursor: isClickable ? 'pointer' : 'default' }}
                      role={isClickable ? 'button' : undefined}
                      tabIndex={isClickable ? 0 : undefined}
                      aria-label={`${planet.key} at ${planet.degree}°${planet.statusFlags.length > 0 ? `, ${planet.statusFlags.join(' ')}` : ''}`}
                    >
                      {/* Planet Symbol */}
                      <text
                        x={x}
                        y={y}
                        fontSize={fontSizes.symbol}
                        fontWeight="bold"
                        textAnchor="middle"
                        dominantBaseline="middle"
                        className="fill-[hsl(var(--chart-text))]"
                      >
                        {planet.symbol}
                      </text>

                      {/* Degree (top-right superscript) */}
                      <text
                        x={x + 12}
                        y={y - 6}
                        fontSize={fontSizes.degree}
                        textAnchor="start"
                        dominantBaseline="middle"
                        className="fill-[hsl(var(--chart-text-secondary))]"
                      >
                        {Math.round(planet.degree)}°
                      </text>

                      {/* Status Flags */}
                      {planet.statusFlags.length > 0 && (
                        <text
                          x={x}
                          y={y + 12}
                          fontSize={fontSizes.status}
                          textAnchor="middle"
                          dominantBaseline="middle"
                          className="fill-[hsl(var(--chart-status))]"
                        >
                          {planet.statusFlags.join(' ')}
                        </text>
                      )}
                    </g>
                  );
                })}
              </g>
            );
          })}

          {/* Clickable House Overlays */}
          {onHouseClick && houses.map((house) => {
            const pos = HOUSE_POSITIONS[house.houseNumber];
            return (
              <circle
                key={`click-house-${house.houseNumber}`}
                cx={pos.x}
                cy={pos.y}
                r="50"
                fill="transparent"
                onClick={() => onHouseClick(house.houseNumber)}
                style={{ cursor: 'pointer' }}
                role="button"
                tabIndex={0}
                aria-label={`House ${house.houseNumber}, ${house.rasiName}`}
              />
            );
          })}
        </DiamondGrid>
      </div>
    </div>
  );
}
